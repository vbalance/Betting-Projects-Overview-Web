name: üöÄ Deploy to AWS S3 + CloudFront

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  deploy:
    name: üåê Deploy to AWS
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4

    - name: üü¢ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        npm ci
        echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º TypeScript..."
        npx tsc --noEmit || echo "‚ö†Ô∏è TypeScript warnings found, continuing..."
        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã"

    - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
      run: |
        echo "üèóÔ∏è –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
        npm run build
        echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
        ls -la build/
      env:
        CI: false
        GENERATE_SOURCEMAP: false

    - name: üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ AWS CLI
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: üì§ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å S3
      run: |
        echo "üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –≤ S3 bucket: ${{ secrets.S3_BUCKET_NAME }}"
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –∫—Ä–æ–º–µ HTML —Å –¥–ª–∏—Ç–µ–ª—å–Ω—ã–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        aws s3 sync build/ s3://${{ secrets.S3_BUCKET_NAME }} \
          --delete \
          --cache-control "max-age=31536000,public" \
          --exclude "*.html" \
          --exclude "*.json"
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º HTML —Ñ–∞–π–ª—ã –±–µ–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
        aws s3 sync build/ s3://${{ secrets.S3_BUCKET_NAME }} \
          --cache-control "max-age=0,no-cache,no-store,must-revalidate" \
          --include "*.html" \
          --include "*.json"
        
        echo "‚úÖ –§–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ S3"

    - name: üîÑ –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è CloudFront –∫—ç—à–∞
      run: |
        echo "üîÑ –û—á–∏—â–∞–µ–º CloudFront –∫—ç—à..."
        INVALIDATION_ID=$(aws cloudfront create-invalidation \
          --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
          --paths "/*" \
          --query 'Invalidation.Id' \
          --output text)
        
        echo "üîÑ –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞ —Å ID: $INVALIDATION_ID"
        echo "‚è≥ –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏..."
        
        aws cloudfront wait invalidation-completed \
          --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
          --id $INVALIDATION_ID
        
        echo "‚úÖ –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è CloudFront –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"

    - name: üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω
      run: |
        echo "üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
        echo "üåê –í–∞—à —Å–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É:"
        echo "   https://${{ secrets.CLOUDFRONT_DOMAIN }}"
        echo ""
        echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–µ–ø–ª–æ—è:"
        echo "   üì¶ –°–æ–±—Ä–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: $(find build -type f | wc -l)"
        echo "   üì§ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –≤ S3: ${{ secrets.S3_BUCKET_NAME }}"
        echo "   üîÑ CloudFront –æ–±–Ω–æ–≤–ª–µ–Ω: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}"

    - name: üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ PR (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `üöÄ **Preview Deploy –≥–æ—Ç–æ–≤!**
            
            üåê **URL:** https://${{ secrets.CLOUDFRONT_DOMAIN }}
            
            ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é.`
          })
